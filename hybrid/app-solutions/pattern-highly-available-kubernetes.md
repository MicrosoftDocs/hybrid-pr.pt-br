---
title: Padrão do Kubernetes de alta disponibilidade usando o Azure e o Azure Stack Hub
description: Saiba como uma solução de cluster do Kubernetes fornece alta disponibilidade usando o Azure e o Azure Stack Hub.
author: BryanLa
ms.topic: article
ms.date: 12/03/2020
ms.author: bryanla
ms.reviewer: bryanla
ms.lastreviewed: 12/03/2020
ms.openlocfilehash: 454cc0a0531882b7a8ec050a461420ce13eebcfe
ms.sourcegitcommit: df7e3e6423c3d4e8a42dae3d1acfba1d55057258
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/09/2020
ms.locfileid: "96911997"
---
# <a name="high-availability-kubernetes-cluster-pattern"></a><span data-ttu-id="aa7a3-103">Padrão de cluster do Kubernetes de alta disponibilidade</span><span class="sxs-lookup"><span data-stu-id="aa7a3-103">High availability Kubernetes cluster pattern</span></span>

<span data-ttu-id="aa7a3-104">Este artigo descreve como arquitetar e operar uma infraestrutura altamente disponível baseada no Kubernetes usando o Mecanismo do AKS (Serviço de Kubernetes do Azure) no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-104">This article describes how to architect and operate a highly available Kubernetes-based infrastructure using Azure Kubernetes Service (AKS) Engine on Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-105">Esse cenário é comum para as organizações com cargas de trabalho críticas em ambientes altamente restritos e regulamentados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-105">This scenario is common for organizations with critical workloads in highly restricted and regulated environments.</span></span> <span data-ttu-id="aa7a3-106">Organizações em domínios como finanças, defesa e governo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-106">Organizations in domains such as finance, defense, and government.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="aa7a3-107">Contexto e problema</span><span class="sxs-lookup"><span data-stu-id="aa7a3-107">Context and problem</span></span>

<span data-ttu-id="aa7a3-108">Muitas organizações estão desenvolvendo soluções nativas de nuvem que aproveitam serviços e tecnologias de ponta como o Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-108">Many organizations are developing cloud-native solutions that leverage state-of-the-art services and technologies like Kubernetes.</span></span> <span data-ttu-id="aa7a3-109">Embora o Azure forneça datacenters na maioria das regiões do mundo, às vezes, há casos de uso de borda e cenários em que aplicativos comercialmente críticos precisam ser executados em uma localização específica.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-109">Although Azure provides datacenters in most regions of the world, sometimes there are edge use-cases and scenarios where business critical applications must run in a specific location.</span></span> <span data-ttu-id="aa7a3-110">Entre as considerações estão:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-110">Considerations include:</span></span>

- <span data-ttu-id="aa7a3-111">Confidencialidade de localização</span><span class="sxs-lookup"><span data-stu-id="aa7a3-111">Location sensitivity</span></span>
- <span data-ttu-id="aa7a3-112">Latência entre o aplicativo e os sistemas locais</span><span class="sxs-lookup"><span data-stu-id="aa7a3-112">Latency between the application and on-premises systems</span></span>
- <span data-ttu-id="aa7a3-113">Conservação da largura de banda</span><span class="sxs-lookup"><span data-stu-id="aa7a3-113">Bandwidth conservation</span></span>
- <span data-ttu-id="aa7a3-114">Conectividade</span><span class="sxs-lookup"><span data-stu-id="aa7a3-114">Connectivity</span></span>
- <span data-ttu-id="aa7a3-115">Requisitos regulatórios ou legais</span><span class="sxs-lookup"><span data-stu-id="aa7a3-115">Regulatory or statutory requirements</span></span>

<span data-ttu-id="aa7a3-116">O Azure, em combinação com o Azure Stack Hub, resolve a maioria dessas preocupações.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-116">Azure, in combination with Azure Stack Hub, addresses most of these concerns.</span></span> <span data-ttu-id="aa7a3-117">Um amplo conjunto de opções, decisões e considerações para uma implementação bem-sucedida do Kubernetes em execução no Azure Stack Hub é descrito abaixo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-117">A broad set of options, decisions, and considerations for a successful implementation of Kubernetes running on Azure Stack Hub is described below.</span></span>

## <a name="solution"></a><span data-ttu-id="aa7a3-118">Solução</span><span class="sxs-lookup"><span data-stu-id="aa7a3-118">Solution</span></span>

<span data-ttu-id="aa7a3-119">Esse padrão pressupõe que precisamos lidar com um conjunto estrito de restrições.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-119">This pattern assumes that we have to deal with a strict set of constraints.</span></span> <span data-ttu-id="aa7a3-120">O aplicativo precisa ser executado no local e todos os dados pessoais não devem alcançar serviços de nuvem pública.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-120">The application must run on-premises and all personal data must not reach public cloud services.</span></span> <span data-ttu-id="aa7a3-121">O monitoramento e outros dados não PII podem ser enviados para o Azure e ser processados nele.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-121">Monitoring and other non-PII data can be sent to Azure and be processed there.</span></span> <span data-ttu-id="aa7a3-122">Serviços externos, como um Registro de Contêiner público ou outros, podem ser acessados, mas podem ser filtrados por meio de um firewall ou um servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-122">External services like a public Container Registry or others can be accessed but might be filtered through a firewall or proxy server.</span></span>

<span data-ttu-id="aa7a3-123">O aplicativo de exemplo mostrado aqui (com base no [Workshop do Serviço de Kubernetes do Azure](/learn/modules/aks-workshop/)) foi projetado para usar soluções nativas do Kubernetes sempre que possível.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-123">The sample application shown here (based on [Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) is designed to use Kubernetes-native solutions whenever possible.</span></span> <span data-ttu-id="aa7a3-124">Esse design evita o bloqueio de fornecedor, em vez de usar serviços nativos de plataforma.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-124">This design avoids vendor lock-in, instead of using platform-native services.</span></span> <span data-ttu-id="aa7a3-125">Por exemplo, o aplicativo usa um back-end do banco de dados MongoDB auto-hospedado, em vez de um serviço de PaaS ou um serviço de banco de dados externo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-125">As an example, the application uses a self-hosted MongoDB database backend instead of a PaaS service or external database service.</span></span>

<span data-ttu-id="aa7a3-126">[![Padrão de aplicativo híbrido](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-126">[![Application Pattern Hybrid](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span></span>

<span data-ttu-id="aa7a3-127">O diagrama anterior ilustra a arquitetura do aplicativo de exemplo em execução no Kubernetes no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-127">The preceding diagram illustrates the application architecture of the sample application running on Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-128">O aplicativo consiste em vários componentes, incluindo:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-128">The app consists of several components, including:</span></span>

 1) <span data-ttu-id="aa7a3-129">Um Mecanismo do AKS baseado em um cluster do Kubernetes no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-129">An AKS Engine based Kubernetes cluster on Azure Stack Hub.</span></span>
 2) <span data-ttu-id="aa7a3-130">O [cert-manager](https://www.jetstack.io/cert-manager/), que fornece um pacote de ferramentas para o gerenciamento de certificados no Kubernetes, usado para solicitar automaticamente certificados do Let's Encrypt.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-130">[cert-manager](https://www.jetstack.io/cert-manager/), which provides a suite of tools for certificate management in Kubernetes, used to automatically request certificates from Let's Encrypt.</span></span>
 3) <span data-ttu-id="aa7a3-131">Um namespace do Kubernetes que contém os componentes do aplicativo para o front-end (ratings-web), a API (ratings-api) e o banco de dados (ratings-mongodb).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-131">A Kubernetes namespace that contains the application components for the front end (ratings-web), api (ratings-api), and database (ratings-mongodb).</span></span>
 4) <span data-ttu-id="aa7a3-132">O controlador de entrada que roteia o tráfego HTTP/HTTPS para pontos de extremidade no cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-132">The Ingress Controller that routes HTTP/HTTPS traffic to endpoints within the Kubernetes cluster.</span></span>

<span data-ttu-id="aa7a3-133">O aplicativo de exemplo é usado para ilustrar a arquitetura do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-133">The sample application is used to illustrate the application architecture.</span></span> <span data-ttu-id="aa7a3-134">Todos os componentes são exemplos.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-134">All components are examples.</span></span> <span data-ttu-id="aa7a3-135">A arquitetura contém apenas uma implantação de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-135">The architecture contains only a single application deployment.</span></span> <span data-ttu-id="aa7a3-136">Para obter HA (alta disponibilidade), executaremos a implantação, pelo menos, duas vezes em duas instâncias diferentes do Azure Stack Hub: elas podem ser executadas na mesma localização ou em dois (ou mais) sites diferentes:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-136">To achieve high availability (HA), we'll run the deployment at least twice on two different Azure Stack Hub instances - they can run either in the same location or in two (or more) different sites:</span></span>

![Arquitetura de infraestrutura](media/pattern-highly-available-kubernetes/aks-azure-architecture.png)

<span data-ttu-id="aa7a3-138">Serviços como o Registro de Contêiner do Azure, o Azure Monitor e outros são hospedados fora do Azure Stack Hub no Azure ou no local.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-138">Services like Azure Container Registry, Azure Monitor, and others, are hosted outside Azure Stack Hub in Azure or on-premises.</span></span> <span data-ttu-id="aa7a3-139">Esse design híbrido protege a solução contra a interrupção de uma instância individual do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-139">This hybrid design protects the solution against outage of a single Azure Stack Hub instance.</span></span>

## <a name="components"></a><span data-ttu-id="aa7a3-140">Componentes</span><span class="sxs-lookup"><span data-stu-id="aa7a3-140">Components</span></span>

<span data-ttu-id="aa7a3-141">A arquitetura geral é formada pelos seguintes componentes:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-141">The overall architecture consists of the following components:</span></span>

<span data-ttu-id="aa7a3-142">O **Azure Stack Hub** é uma extensão do Azure que pode executar cargas de trabalho em um ambiente local fornecendo serviços do Azure no seu datacenter.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-142">**Azure Stack Hub** is an extension of Azure that can run workloads in an on-premises environment by providing Azure services in your datacenter.</span></span> <span data-ttu-id="aa7a3-143">Acesse [Visão geral do Azure Stack Hub](/azure-stack/operator/azure-stack-overview) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-143">Go to [Azure Stack Hub overview](/azure-stack/operator/azure-stack-overview) to learn more.</span></span>

<span data-ttu-id="aa7a3-144">O **Mecanismo do AKS (Serviço de Kubernetes do Azure)** é o mecanismo por trás da oferta de serviço Kubernetes gerenciado, o AKS (Serviço de Kubernetes do Azure), que está disponível hoje no Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-144">**Azure Kubernetes Service Engine (AKS Engine)** is the engine behind the managed Kubernetes service offering, Azure Kubernetes Service (AKS), that is available in Azure today.</span></span> <span data-ttu-id="aa7a3-145">Para o Azure Stack Hub, o Mecanismo do AKS nos permite implantar, escalar e atualizar clusters do Kubernetes autogerenciados completos usando as funcionalidades de IaaS do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-145">For Azure Stack Hub, AKS Engine allows us to deploy, scale, and upgrade fully featured, self-managed Kubernetes clusters using Azure Stack Hub's IaaS capabilities.</span></span> <span data-ttu-id="aa7a3-146">Acesse [Visão geral do Mecanismo do AKS](https://github.com/Azure/aks-engine) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-146">Go to [AKS Engine Overview](https://github.com/Azure/aks-engine) to learn more.</span></span>

<span data-ttu-id="aa7a3-147">Acesse [Problemas conhecidos e limitações](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) para saber mais sobre as diferenças entre o Mecanismo do AKS no Azure e o Mecanismo do AKS no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-147">Go to [Known Issues and Limitations](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) to learn more about the differences between AKS Engine on Azure and AKS Engine on Azure Stack Hub.</span></span>

<span data-ttu-id="aa7a3-148">A **VNet (Rede Virtual) do Azure** é usada para fornecer a infraestrutura de rede em cada Azure Stack Hub para as VMs (Máquinas Virtuais) que hospedam a infraestrutura de cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-148">**Azure Virtual Network (VNet)** is used to provide the network infrastructure on each Azure Stack Hub for the Virtual Machines (VMs) hosting the Kubernetes cluster infrastructure.</span></span>

<span data-ttu-id="aa7a3-149">O **Azure Load Balancer** é usado para o Ponto de Extremidade de API do Kubernetes e o controlador de entrada NGINX.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-149">**Azure Load Balancer** is used for the Kubernetes API Endpoint and the Nginx Ingress Controller.</span></span> <span data-ttu-id="aa7a3-150">O balanceador de carga roteia o tráfego externo (por exemplo, Internet) para os nós e as VMs que oferecem um serviço específico.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-150">The load balancer routes external (for example, Internet) traffic to nodes and VMs offering a specific service.</span></span>

<span data-ttu-id="aa7a3-151">O **ACR (Registro de Contêiner do Azure)** é usado para armazenar imagens privadas do Docker e gráficos do Helm, que são implantados no cluster.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-151">**Azure Container Registry (ACR)** is used to store private Docker images and Helm charts, which are deployed to the cluster.</span></span> <span data-ttu-id="aa7a3-152">O Mecanismo do AKS pode se autenticar no Registro de Contêiner usando uma identidade do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-152">AKS Engine can authenticate with the Container Registry using an Azure AD identity.</span></span> <span data-ttu-id="aa7a3-153">O Kubernetes não exige o ACR.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-153">Kubernetes doesn't require ACR.</span></span> <span data-ttu-id="aa7a3-154">Você pode usar outros registros de contêiner, como o Hub do Docker.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-154">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="aa7a3-155">O **Azure Repos** é um conjunto de ferramentas de controle de versão que você pode usar para gerenciar seu código.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-155">**Azure Repos** is a set of version control tools that you can use to manage your code.</span></span> <span data-ttu-id="aa7a3-156">Use também o GitHub ou outros repositórios baseados no Git.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-156">You can also use GitHub or other git-based repositories.</span></span> <span data-ttu-id="aa7a3-157">Acesse [Visão geral do Azure Repos](/azure/devops/repos/get-started/what-is-repos) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-157">Go to [Azure Repos Overview](/azure/devops/repos/get-started/what-is-repos) to learn more.</span></span>

<span data-ttu-id="aa7a3-158">O **Azure Pipelines** faz parte do Azure DevOps Services e executa builds, implantações e testes automatizados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-158">**Azure Pipelines** is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="aa7a3-159">Você também pode usar soluções de CI/CD de terceiros, como o Jenkins.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-159">You can also use third-party CI/CD solutions such as Jenkins.</span></span> <span data-ttu-id="aa7a3-160">Acesse [Visão geral do Azure Pipeline](/azure/devops/pipelines/get-started/what-is-azure-pipelines) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-160">Go to [Azure Pipeline Overview](/azure/devops/pipelines/get-started/what-is-azure-pipelines) to learn more.</span></span>

<span data-ttu-id="aa7a3-161">O **Azure Monitor** coleta e armazena métricas e logs, incluindo a métrica de plataforma para os serviços do Azure na telemetria do aplicativo e da solução.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-161">**Azure Monitor** collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="aa7a3-162">Use esses dados para monitorar o aplicativo, configurar alertas e painéis e executar a análise da causa raiz de falhas.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-162">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="aa7a3-163">O Azure Monitor integra-se ao Kubernetes para coletar métricas de controladores, nós e contêineres, bem como logs do contêiner e logs do nó mestre.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-163">Azure Monitor integrates with Kubernetes to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span> <span data-ttu-id="aa7a3-164">Acesse [Visão geral do Azure Monitor](/azure/azure-monitor/overview) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-164">Go to [Azure Monitor Overview](/azure/azure-monitor/overview) to learn more.</span></span>

<span data-ttu-id="aa7a3-165">O **Gerenciador de Tráfego do Azure** é um balanceador de carga de tráfego baseado em DNS que permite distribuir o tráfego de maneira ideal para serviços em diferentes regiões do Azure ou implantações do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-165">**Azure Traffic Manager** is a DNS-based traffic load balancer that enables you to distribute traffic optimally to services across different Azure regions or Azure Stack Hub deployments.</span></span> <span data-ttu-id="aa7a3-166">O Gerenciador de Tráfego também fornece alta disponibilidade e capacidade de resposta.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-166">Traffic Manager also provides high availability and responsiveness.</span></span> <span data-ttu-id="aa7a3-167">Os pontos de extremidade do aplicativo precisam ser acessíveis externamente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-167">The application endpoints must be accessible from the outside.</span></span> <span data-ttu-id="aa7a3-168">Também há outras soluções locais disponíveis.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-168">There are other on-premises solutions available as well.</span></span>

<span data-ttu-id="aa7a3-169">O **controlador de entrada do Kubernetes** expõe as rotas HTTP(S) aos serviços em um cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-169">**Kubernetes Ingress Controller** exposes HTTP(S) routes to services in a Kubernetes cluster.</span></span> <span data-ttu-id="aa7a3-170">O NGINX ou qualquer controlador de entrada adequado pode ser usado para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-170">Nginx or any suitable ingress controller can be used for this purpose.</span></span>

<span data-ttu-id="aa7a3-171">O **Helm** é um gerenciador de pacotes para a implantação do Kubernetes, fornecendo uma forma de agrupar diferentes objetos do Kubernetes, como implantações, serviços, segredos, em um só "gráfico".</span><span class="sxs-lookup"><span data-stu-id="aa7a3-171">**Helm** is a package manager for Kubernetes deployment, providing a way to bundle different Kubernetes objects like Deployments, Services, Secrets, into a single "chart".</span></span> <span data-ttu-id="aa7a3-172">Você pode publicar, implantar e atualizar um objeto de gráfico, além de controlar o gerenciamento de versão dele.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-172">You can publish, deploy, control version management, and update a chart  object.</span></span> <span data-ttu-id="aa7a3-173">O Registro de Contêiner do Azure pode ser usado como um repositório para armazenar gráficos empacotados do Helm.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-173">Azure Container Registry can be used as a repository to store packaged Helm Charts.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="aa7a3-174">Considerações sobre o design</span><span class="sxs-lookup"><span data-stu-id="aa7a3-174">Design considerations</span></span>

<span data-ttu-id="aa7a3-175">Esse padrão segue algumas considerações de alto nível explicadas mais detalhadamente nas próximas seções deste artigo:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-175">This pattern follows a few high-level considerations explained in more detail in the next sections of this article:</span></span>

- <span data-ttu-id="aa7a3-176">O aplicativo usa soluções nativas do Kubernetes para evitar o bloqueio de fornecedor.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-176">The application uses Kubernetes-native solutions, to avoid vendor lock-in.</span></span>
- <span data-ttu-id="aa7a3-177">Ele usa uma arquitetura de microsserviços.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-177">The application uses a microservices architecture.</span></span>
- <span data-ttu-id="aa7a3-178">O Azure Stack Hub não precisa de entrada, mas permite a conectividade de saída com a Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-178">Azure Stack Hub doesn't need inbound but allows outbound Internet connectivity.</span></span>

<span data-ttu-id="aa7a3-179">Essas práticas recomendadas também serão aplicadas a cargas de trabalho e cenários do mundo real.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-179">These recommended practices will apply to real-world workloads and scenarios as well.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="aa7a3-180">Considerações sobre escalabilidade</span><span class="sxs-lookup"><span data-stu-id="aa7a3-180">Scalability considerations</span></span>

<span data-ttu-id="aa7a3-181">A escalabilidade é importante para fornecer aos usuários acesso consistente, confiável e de bom desempenho ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-181">Scalability is important to provide users consistent, reliable, and well-performing access to the application.</span></span>

<span data-ttu-id="aa7a3-182">O cenário de exemplo aborda a escalabilidade em várias camadas da pilha de aplicativos.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-182">The sample scenario covers scalability on multiple layers of the application stack.</span></span> <span data-ttu-id="aa7a3-183">Esta é uma visão geral de alto nível das diferentes camadas:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-183">Here's a high-level overview of the different layers:</span></span>

| <span data-ttu-id="aa7a3-184">Nível de arquitetura</span><span class="sxs-lookup"><span data-stu-id="aa7a3-184">Architecture level</span></span> | <span data-ttu-id="aa7a3-185">Afeta</span><span class="sxs-lookup"><span data-stu-id="aa7a3-185">Affects</span></span> | <span data-ttu-id="aa7a3-186">Como posso fazer isso?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-186">How?</span></span> |
| --- | --- | ---
| <span data-ttu-id="aa7a3-187">Aplicativo</span><span class="sxs-lookup"><span data-stu-id="aa7a3-187">Application</span></span> | <span data-ttu-id="aa7a3-188">Aplicativo</span><span class="sxs-lookup"><span data-stu-id="aa7a3-188">Application</span></span> | <span data-ttu-id="aa7a3-189">Escala horizontal com base no número de pods/réplicas/Instâncias de Contêiner\*</span><span class="sxs-lookup"><span data-stu-id="aa7a3-189">Horizontal scaling based on the number of Pods/Replicas/Container Instances\*</span></span> |
| <span data-ttu-id="aa7a3-190">Cluster</span><span class="sxs-lookup"><span data-stu-id="aa7a3-190">Cluster</span></span> | <span data-ttu-id="aa7a3-191">Cluster do Kubernetes</span><span class="sxs-lookup"><span data-stu-id="aa7a3-191">Kubernetes cluster</span></span> | <span data-ttu-id="aa7a3-192">Número de nós (entre 1 e 50), tamanhos de SKU da VM e pools de nós (atualmente, o Mecanismo do AKS no Azure Stack Hub só dá suporte a um pool de nós); uso do comando scale do Mecanismo do AKS (manual)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-192">Number of Nodes (between 1 and 50), VM-SKU-sizes, and Node Pools (AKS Engine on Azure Stack Hub currently supports only a single node pool); using AKS Engine's scale command (manual)</span></span> |
| <span data-ttu-id="aa7a3-193">Infraestrutura</span><span class="sxs-lookup"><span data-stu-id="aa7a3-193">Infrastructure</span></span> | <span data-ttu-id="aa7a3-194">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-194">Azure Stack Hub</span></span> | <span data-ttu-id="aa7a3-195">Número de nós, capacidade e unidades de escala em uma implantação do Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-195">Number of nodes, capacity, and scale units within an Azure Stack Hub deployment</span></span> |

<span data-ttu-id="aa7a3-196">\* Uso do HPA (Dimensionador Automático de Pod Horizontal) do Kubernetes; escala automatizada baseada em métrica ou escala vertical pelo dimensionamento das instâncias de contêiner (CPU/memória).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-196">\* Using Kubernetes' Horizontal Pod Autoscaler (HPA); automated metric-based scaling or vertical scaling by sizing the container instances (cpu/memory).</span></span>

<span data-ttu-id="aa7a3-197">**Azure Stack Hub (nível de infraestrutura)**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-197">**Azure Stack Hub (infrastructure level)**</span></span>

<span data-ttu-id="aa7a3-198">A infraestrutura do Azure Stack Hub é a base dessa implementação, porque o Azure Stack Hub é executado em um hardware físico em um datacenter.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-198">The Azure Stack Hub infrastructure is the foundation of this implementation, because Azure Stack Hub runs on physical hardware in a datacenter.</span></span> <span data-ttu-id="aa7a3-199">Ao selecionar o hardware do Hub, você precisa fazer escolhas para CPU, densidade de memória, configuração de armazenamento e número de servidores.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-199">When selecting your Hub hardware, you need to make choices for CPU, memory density, storage configuration, and number of servers.</span></span> <span data-ttu-id="aa7a3-200">Para saber mais sobre a escalabilidade do Azure Stack Hub, confira os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-200">To learn more about Azure Stack Hub's scalability, check out the following resources:</span></span>

- [<span data-ttu-id="aa7a3-201">Visão geral do planejamento da capacidade para o Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-201">Capacity planning for Azure Stack Hub overview</span></span>](/azure-stack/operator/azure-stack-capacity-planning-overview)
- [<span data-ttu-id="aa7a3-202">Adicionar mais nós de unidade de escala no Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-202">Add additional scale unit nodes in Azure Stack Hub</span></span>](/azure-stack/operator/azure-stack-add-scale-node)

<span data-ttu-id="aa7a3-203">**Cluster do Kubernetes (nível de cluster)**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-203">**Kubernetes cluster (cluster level)**</span></span>

<span data-ttu-id="aa7a3-204">O próprio cluster do Kubernetes é formado por componentes de IaaS (pilha) do Azure, incluindo recursos de computação, armazenamento e rede, e é criado com base neles.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-204">The Kubernetes cluster itself consists of, and is built on top of Azure (Stack) IaaS components including compute, storage, and network resources.</span></span> <span data-ttu-id="aa7a3-205">As soluções do Kubernetes envolvem nós mestres e de trabalho, que são implantados como VMs no Azure (e no Azure Stack Hub).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-205">Kubernetes solutions involve master and worker nodes, which are deployed as VMs in Azure (and Azure Stack Hub).</span></span>

- <span data-ttu-id="aa7a3-206">Os [nós do painel de controle](/azure/aks/concepts-clusters-workloads#control-plane) (mestre) fornecem os serviços principais do Kubernetes e a orquestração de cargas de trabalho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-206">[Control plane nodes](/azure/aks/concepts-clusters-workloads#control-plane) (master) provide the core Kubernetes services and orchestration of application workloads.</span></span>
- <span data-ttu-id="aa7a3-207">Os [nós de trabalho](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (trabalho) executam as cargas de trabalhos do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-207">[Worker nodes](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (worker) run your application workloads.</span></span>

<span data-ttu-id="aa7a3-208">Ao selecionar tamanhos de VM para a implantação inicial, há várias considerações:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-208">When selecting VM sizes for the initial deployment, there are several considerations:</span></span>  

- <span data-ttu-id="aa7a3-209">**Custo**: ao planejar seus nós de trabalho, tenha em mente o custo geral por VM que você pagará.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-209">**Cost** - When planning your worker nodes, keep in mind the overall cost per VM you'll incur.</span></span> <span data-ttu-id="aa7a3-210">Por exemplo, se as cargas de trabalho do aplicativo exigirem recursos limitados, você deverá planejar a implantação de VMs menores.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-210">For example, if your application workloads require limited resources, you should plan to deploy smaller sized VMs.</span></span> <span data-ttu-id="aa7a3-211">O Azure Stack Hub, como o Azure, normalmente é cobrado de acordo com o consumo. Portanto, o dimensionamento adequado das VMs para as funções do Kubernetes é crucial para otimizar os custos de consumo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-211">Azure Stack Hub, like Azure, is normally billed on a consumption basis, so appropriately sizing the VMs for Kubernetes roles is crucial to optimizing consumption costs.</span></span> 

- <span data-ttu-id="aa7a3-212">**Escalabilidade**: a escalabilidade do cluster é obtida pela escala e pela redução do número de nós mestres e de trabalho ou pela adição de pools de nós extras (não disponíveis atualmente no Azure Stack Hub).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-212">**Scalability** - Scalability of the cluster is achieved by scaling in and out the number of master and worker nodes, or by adding additional node pools (not available on Azure Stack Hub today).</span></span> <span data-ttu-id="aa7a3-213">A escala do cluster pode ser feita com base nos dados de desempenho, coletados com o uso de Insights de Contêiner (Azure Monitor + Log Analytics).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-213">Scaling the cluster can be done based on performance data, collected using Container Insights (Azure Monitor + Log Analytics).</span></span> 

    <span data-ttu-id="aa7a3-214">Se o seu aplicativo precisar de mais (ou menos) recursos, escale ou reduza horizontalmente os nós atuais (entre 1 e 50 nós).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-214">If your application needs more (or fewer) resources, you can scale out (or in) your current nodes horizontally (between 1 and 50 nodes).</span></span> <span data-ttu-id="aa7a3-215">Caso precise de mais de 50 nós, crie um cluster adicional em uma assinatura separada.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-215">If you need more than 50 nodes, you can create an additional cluster in a separate subscription.</span></span> <span data-ttu-id="aa7a3-216">Você não poderá escalar verticalmente as VMs reais para outro tamanho de VM sem reimplantar o cluster.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-216">You can't scale up the actual VMs vertically to another VM size without redeploying the cluster.</span></span>

    <span data-ttu-id="aa7a3-217">A escala é feita manualmente usando a VM auxiliar do Mecanismo do AKS que foi usada para implantar inicialmente o cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-217">Scaling is done manually using the AKS Engine helper VM that was used to deploy the Kubernetes cluster initially.</span></span> <span data-ttu-id="aa7a3-218">Para obter mais informações, confira [Como escalar clusters do Kubernetes](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-218">For more information, see [Scaling Kubernetes clusters](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span></span>

- <span data-ttu-id="aa7a3-219">**Cotas**: considere as [cotas](/azure-stack/operator/azure-stack-quota-types) que você configurou ao planejar uma implantação do AKS no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-219">**Quotas** - Consider the [quotas](/azure-stack/operator/azure-stack-quota-types) you've configured when planning out an AKS deployment on your Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-220">Verifique se cada [assinatura](/azure-stack/operator/service-plan-offer-subscription-overview) tem as cotas e os planos adequados configurados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-220">Make sure each [subscription](/azure-stack/operator/service-plan-offer-subscription-overview) has the proper plans and the quotas configured.</span></span> <span data-ttu-id="aa7a3-221">A assinatura precisará acomodar a quantidade de computação, armazenamento e outros serviços necessários para seus clusters à medida que eles escalarem horizontalmente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-221">The subscription will need to accommodate the amount of compute, storage, and other services needed for your clusters as they scale out.</span></span>

- <span data-ttu-id="aa7a3-222">**Cargas de trabalho do aplicativo**: veja os [conceitos de clusters e cargas de trabalho](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) no documento Principais conceitos do Kubernetes para o Serviço de Kubernetes do Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-222">**Application workloads** - Refer to the [Clusters and workloads concepts](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) in the Kubernetes core concepts for Azure Kubernetes Service document.</span></span> <span data-ttu-id="aa7a3-223">Este artigo ajudará você a definir o escopo do tamanho adequado da VM com base nas necessidades de computação e memória do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-223">This article will help you scope the proper VM size based on the compute and memory needs of your application.</span></span>  

<span data-ttu-id="aa7a3-224">**Aplicativo (nível de aplicativo)**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-224">**Application (application level)**</span></span>

<span data-ttu-id="aa7a3-225">Na camada de aplicativo, usamos o [HPA (Dimensionador Automático de Pod Horizontal)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/) do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-225">On the application layer, we use Kubernetes [Horizontal Pod Autoscaler (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/).</span></span> <span data-ttu-id="aa7a3-226">O HPA pode aumentar ou diminuir o número de réplicas (pod/Instâncias de Contêiner) em nossa implantação com base em diferentes métricas (como utilização da CPU).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-226">HPA can increase or decrease the number of Replicas (Pod/Container Instances) in our deployment based on different metrics (like CPU utilization).</span></span>

<span data-ttu-id="aa7a3-227">Outra opção é escalar as instâncias de contêiner verticalmente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-227">Another option is to scale container instances vertically.</span></span> <span data-ttu-id="aa7a3-228">Faça isso alterando a quantidade de CPU e memória solicitada e disponível para uma implantação específica.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-228">This can be accomplished by changing the amount of CPU and Memory requested and available for a specific deployment.</span></span> <span data-ttu-id="aa7a3-229">Confira [Como gerenciar recursos para contêineres](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) em kubernetes.io para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-229">See [Managing Resources for Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) on kubernetes.io to learn more.</span></span>

## <a name="networking-and-connectivity-considerations"></a><span data-ttu-id="aa7a3-230">Considerações sobre rede e conectividade</span><span class="sxs-lookup"><span data-stu-id="aa7a3-230">Networking and connectivity considerations</span></span>

<span data-ttu-id="aa7a3-231">A rede e a conectividade também afetam as três camadas mencionadas anteriormente para o Kubernetes no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-231">Networking and connectivity also affect the three layers mentioned previously for Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-232">A seguinte tabela mostra as camadas e os serviços que elas contêm:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-232">The following table shows the layers and which services they contain:</span></span>

| <span data-ttu-id="aa7a3-233">Camada</span><span class="sxs-lookup"><span data-stu-id="aa7a3-233">Layer</span></span> | <span data-ttu-id="aa7a3-234">Afeta</span><span class="sxs-lookup"><span data-stu-id="aa7a3-234">Affects</span></span> | <span data-ttu-id="aa7a3-235">O quê?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-235">What?</span></span> |
| --- | --- | ---
| <span data-ttu-id="aa7a3-236">Aplicativo</span><span class="sxs-lookup"><span data-stu-id="aa7a3-236">Application</span></span> | <span data-ttu-id="aa7a3-237">Aplicativo</span><span class="sxs-lookup"><span data-stu-id="aa7a3-237">Application</span></span> | <span data-ttu-id="aa7a3-238">Como o aplicativo fica acessível?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-238">How is the application accessible?</span></span> <span data-ttu-id="aa7a3-239">Ele será exposto à Internet?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-239">Will it be exposed to the Internet?</span></span> |
| <span data-ttu-id="aa7a3-240">Cluster</span><span class="sxs-lookup"><span data-stu-id="aa7a3-240">Cluster</span></span> | <span data-ttu-id="aa7a3-241">Cluster do Kubernetes</span><span class="sxs-lookup"><span data-stu-id="aa7a3-241">Kubernetes cluster</span></span> | <span data-ttu-id="aa7a3-242">API do Kubernetes, VM do Mecanismo do AKS, pull de imagens de contêiner (saída), envio de dados de monitoramento e telemetria (saída)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-242">Kubernetes API, AKS Engine VM, Pulling container images (egress), Sending monitoring data and telemetry (egress)</span></span> |
| <span data-ttu-id="aa7a3-243">Infraestrutura</span><span class="sxs-lookup"><span data-stu-id="aa7a3-243">Infrastructure</span></span> | <span data-ttu-id="aa7a3-244">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-244">Azure Stack Hub</span></span> | <span data-ttu-id="aa7a3-245">Acessibilidade dos pontos de extremidade de gerenciamento do Azure Stack Hub como os pontos de extremidade do Azure Resource Manager e do portal.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-245">Accessibility of the Azure Stack Hub management endpoints like the portal and Azure Resource Manager endpoints.</span></span> |

<span data-ttu-id="aa7a3-246">**Aplicativo**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-246">**Application**</span></span>

<span data-ttu-id="aa7a3-247">Para a camada de aplicativo, a consideração mais importante é se o aplicativo é exposto e acessível pela Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-247">For the application layer, the most important consideration is whether the application is exposed and accessible from the Internet.</span></span> <span data-ttu-id="aa7a3-248">Da perspectiva do Kubernetes, a acessibilidade da Internet significa expor uma implantação ou um pod usando um Serviço de Kubernetes ou um controlador de entrada.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-248">From a Kubernetes perspective, Internet accessibility means exposing a deployment or pod using a Kubernetes Service or an Ingress Controller.</span></span>

> [!NOTE]
> <span data-ttu-id="aa7a3-249">Recomendamos o uso de controladores de entrada para expor os Serviços de Kubernetes, pois o número de IPs públicos de front-end no Azure Stack Hub é limitado a cinco.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-249">We recommend the use of Ingress controllers to expose Kubernetes Services as the number of Frontend public IPs on Azure Stack Hub is limited to 5.</span></span> <span data-ttu-id="aa7a3-250">Esse design também limita o número de Serviços de Kubernetes (com o tipo LoadBalancer) a 5, que será pequeno demais para muitas implantações.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-250">This design also limits the number of Kubernetes Services (with the type LoadBalancer) to 5, which will be too small for many deployments.</span></span> <span data-ttu-id="aa7a3-251">Acesse a [documentação do Mecanismo do AKS](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) para saber mais.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-251">Go to the [AKS Engine documentation](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) to learn more.</span></span>

<span data-ttu-id="aa7a3-252">Expor um aplicativo usando um IP público por meio de um balanceador de carga ou um controlador de entrada não significa necessariamente que o aplicativo agora é acessível pela Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-252">Exposing an application using a public IP via a Load Balancer or an Ingress Controller doesn't nessecarily mean that the application is now accessible via the Internet.</span></span> <span data-ttu-id="aa7a3-253">É possível que o Azure Stack Hub tenha um endereço IP público que só esteja visível na intranet local, nem todos os IPs públicos são verdadeiramente voltados para a Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-253">It's possible for Azure Stack Hub to have a public IP address that is only visible on the local intranet - not all public IPs are truly Internet-facing.</span></span>

<span data-ttu-id="aa7a3-254">O bloco anterior considera o tráfego de entrada para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-254">The previous block considers ingress traffic to the application.</span></span> <span data-ttu-id="aa7a3-255">Outro tópico que precisa ser considerado para uma implantação bem-sucedida do Kubernetes é o tráfego de saída.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-255">Another topic that must be considered for a successful Kubernetes deployment is outbound/egress traffic.</span></span> <span data-ttu-id="aa7a3-256">Estes são alguns casos de uso que exigem o tráfego de saída:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-256">Here are a few use cases that require egress traffic:</span></span>

- <span data-ttu-id="aa7a3-257">Pull de imagens de contêiner armazenadas no Docker Hub ou no Registro de Contêiner do Azure</span><span class="sxs-lookup"><span data-stu-id="aa7a3-257">Pulling Container Images stored on DockerHub or Azure Container Registry</span></span>
- <span data-ttu-id="aa7a3-258">Recuperação de gráficos do Helm</span><span class="sxs-lookup"><span data-stu-id="aa7a3-258">Retrieving Helm Charts</span></span>
- <span data-ttu-id="aa7a3-259">Emissão de dados do Application Insights (ou outros dados de monitoramento)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-259">Emitting Application Insights data (or other monitoring data)</span></span>

<span data-ttu-id="aa7a3-260">Alguns ambientes corporativos podem exigir o uso de servidores proxy _transparentes_ ou _não transparentes_.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-260">Some enterprise environments might require the use of _transparent_ or _non-transparent_ proxy servers.</span></span> <span data-ttu-id="aa7a3-261">Esses servidores exigem uma configuração específica em vários componentes do nosso cluster.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-261">These servers require specific configuration on various components of our cluster.</span></span> <span data-ttu-id="aa7a3-262">A documentação do Mecanismo do AKS contém vários detalhes sobre como acomodar os proxies de rede.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-262">The AKS Engine documentation contains various details on how to accommodate network proxies.</span></span> <span data-ttu-id="aa7a3-263">Para obter mais detalhes, confira [Mecanismo do AKS e servidores proxy](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-263">For more details, see [AKS Engine and proxy servers](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span></span>

<span data-ttu-id="aa7a3-264">Por fim, o tráfego entre clusters precisa fluir entre as instâncias do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-264">Lastly, cross-cluster traffic must flow between Azure Stack Hub instances.</span></span> <span data-ttu-id="aa7a3-265">A implantação de exemplo consiste em clusters individuais do Kubernetes em execução em instâncias individuais do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-265">The sample deployment consists of individual Kubernetes clusters running on individual Azure Stack Hub instances.</span></span> <span data-ttu-id="aa7a3-266">O tráfego entre eles, como o tráfego de replicação entre dois bancos de dados, é o "tráfego externo".</span><span class="sxs-lookup"><span data-stu-id="aa7a3-266">Traffic between them, such as the replication traffic between two databases, is "external traffic".</span></span> <span data-ttu-id="aa7a3-267">O tráfego externo precisa ser roteado por meio de um VPN site a site ou endereços IP públicos do Azure Stack Hub para conectar o Kubernetes em duas instâncias do Azure Stack Hub:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-267">External traffic must be routed through either a Site-to-Site VPN or Azure Stack Hub Public IP addresses to connect Kubernetes on two Azure Stack Hub instances:</span></span>

![tráfego entre clusters e dentro do cluster](media/pattern-highly-available-kubernetes/aks-inter-and-intra-cluster-traffic.png)

<span data-ttu-id="aa7a3-269">**Cluster**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-269">**Cluster**</span></span>  

<span data-ttu-id="aa7a3-270">O cluster do Kubernetes não precisa necessariamente ser acessível pela Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-270">The Kubernetes cluster doesn't necessarily need to be accessible via the Internet.</span></span> <span data-ttu-id="aa7a3-271">A parte relevante é a API do Kubernetes usada para operar um cluster, por exemplo, usando `kubectl`.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-271">The relevant part is the Kubernetes API used to operate a cluster, for example, using `kubectl`.</span></span> <span data-ttu-id="aa7a3-272">O ponto de extremidade de API do Kubernetes precisa estar acessível a todos que operam o cluster ou que implantam aplicativos e serviços com base nele.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-272">The Kubernetes API endpoint must be accessible to everyone who operates the cluster or deploys applications and services on top of it.</span></span> <span data-ttu-id="aa7a3-273">Este tópico é abordado mais detalhadamente da perspectiva de DevOps na seção [Considerações sobre implantação (CI/CD)](#deployment-cicd-considerations) abaixo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-273">This topic is covered in more detail from a DevOps-perspective in the [Deployment (CI/CD) considerations](#deployment-cicd-considerations) section below.</span></span>

<span data-ttu-id="aa7a3-274">No nível do cluster, também há algumas considerações sobre o tráfego de saída:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-274">On the cluster level, there are also a few considerations around egress-traffic:</span></span>

- <span data-ttu-id="aa7a3-275">Atualizações de nó (para o Ubuntu)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-275">Node updates (for Ubuntu)</span></span>
- <span data-ttu-id="aa7a3-276">Dados de monitoramento (enviados para o Azure Log Analytics)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-276">Monitoring data (sent to Azure LogAnalytics)</span></span>
- <span data-ttu-id="aa7a3-277">Outros agentes que exigem o tráfego de saída (específico de cada ambiente do implantador)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-277">Other agents requiring outbound traffic (specific to each deployer's environment)</span></span>

<span data-ttu-id="aa7a3-278">Antes de implantar o cluster do Kubernetes usando o Mecanismo do AKS, planeje o design final da rede.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-278">Before you deploy your Kubernetes cluster using AKS Engine, plan for the final networking design.</span></span> <span data-ttu-id="aa7a3-279">Em vez de criar uma Rede Virtual dedicada, talvez seja mais eficiente implantar um cluster em uma rede existente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-279">Instead of creating a dedicated Virtual Network, it may be more efficient to deploy a cluster into an existing network.</span></span> <span data-ttu-id="aa7a3-280">Por exemplo, você pode aproveitar uma conexão VPN site a site existente já configurada no seu ambiente do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-280">For example, you might leverage an existing Site-to-Site VPN connection already configured in your Azure Stack Hub environment.</span></span>

<span data-ttu-id="aa7a3-281">**Infraestrutura**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-281">**Infrastructure**</span></span>  

<span data-ttu-id="aa7a3-282">A infraestrutura refere-se ao acesso aos pontos de extremidade de gerenciamento do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-282">Infrastructure refers to accessing the Azure Stack Hub management endpoints.</span></span> <span data-ttu-id="aa7a3-283">Os pontos de extremidade incluem os portais do locatário e do administrador e os pontos de extremidade do administrador e do locatário do Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-283">Endpoints include the tenant and admin portals, and the Azure Resource Manager admin and tenant endpoints.</span></span> <span data-ttu-id="aa7a3-284">Esses pontos de extremidade são necessários para operar o Azure Stack Hub e os serviços principais dele.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-284">These endpoints are required to operate Azure Stack Hub and its core services.</span></span>

## <a name="data-and-storage-considerations"></a><span data-ttu-id="aa7a3-285">Considerações sobre dados e armazenamento</span><span class="sxs-lookup"><span data-stu-id="aa7a3-285">Data and storage considerations</span></span>

<span data-ttu-id="aa7a3-286">Duas instâncias do nosso aplicativo serão implantadas em dois clusters individuais do Kubernetes, em duas instâncias do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-286">Two instances of our application will be deployed, on two individual Kubernetes clusters, across two Azure Stack Hub instances.</span></span> <span data-ttu-id="aa7a3-287">Esse design exigirá que você considere como replicar e sincronizar dados entre elas.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-287">This design will require us to consider how to replicate and synchronize data between them.</span></span>

<span data-ttu-id="aa7a3-288">Com o Azure, temos a capacidade interna de replicar o armazenamento em várias regiões e zonas na nuvem.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-288">With Azure, we have the built-in capability to replicate storage across multiple regions and zones within the cloud.</span></span> <span data-ttu-id="aa7a3-289">Atualmente, com o Azure Stack Hub, não há maneiras nativas de replicar o armazenamento em duas instâncias diferentes do Azure Stack Hub: elas formam duas nuvens independentes sem uma forma abrangente de gerenciá-las como um conjunto.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-289">Currently with Azure Stack Hub there are no native ways to replicate storage across two different Azure Stack Hub instances - they form two independent clouds with no overarching way to manage them as a set.</span></span> <span data-ttu-id="aa7a3-290">O planejamento da resiliência dos aplicativos em execução no Azure Stack Hub força você a considerar essa independência no design e nas implantações do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-290">Planning for resiliency of applications running across Azure Stack Hub forces you to consider this independence in your application design and deployments.</span></span>

<span data-ttu-id="aa7a3-291">Na maioria dos casos, a replicação de armazenamento não será necessária para um aplicativo resiliente e altamente disponível implantado no AKS.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-291">In most cases, storage replication won't be necessary for a resilient and highly available application deployed on AKS.</span></span> <span data-ttu-id="aa7a3-292">Porém, você deve considerar o armazenamento independente por instância do Azure Stack Hub no design do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-292">But you should consider independent storage per Azure Stack Hub instance in your application design.</span></span> <span data-ttu-id="aa7a3-293">Se esse design for uma preocupação ou um obstáculo para implantar a solução no Azure Stack Hub, haverá soluções possíveis de parceiros da Microsoft que fornecem anexos de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-293">If this design is a concern or road block to deploying the solution on Azure Stack Hub, there are possible solutions from Microsoft Partners that provide storage attachments.</span></span> <span data-ttu-id="aa7a3-294">Os anexos de armazenamento fornecem uma solução de replicação de armazenamento entre vários Azure Stack Hubs e o Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-294">Storage attachments provide a storage replication solution across multiple Azure Stack Hubs and Azure.</span></span> <span data-ttu-id="aa7a3-295">Para obter mais informações, confira [Soluções de parceiros](#partner-solutions).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-295">For more information, see the [Partner solutions](#partner-solutions).</span></span>

<span data-ttu-id="aa7a3-296">Em nossa arquitetura, estas camadas foram consideradas:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-296">In our architecture, these layers were considered:</span></span>

<span data-ttu-id="aa7a3-297">**Configuration**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-297">**Configuration**</span></span>

<span data-ttu-id="aa7a3-298">A configuração inclui a configuração do Azure Stack Hub, do Mecanismo do AKS e do próprio cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-298">Configuration includes the configuration of Azure Stack Hub, AKS Engine, and the Kubernetes cluster itself.</span></span> <span data-ttu-id="aa7a3-299">Ela deve ser automatizada o máximo possível e armazenada como uma infraestrutura como código em um sistema de controle de versão baseado no Git, como o Azure DevOps ou o GitHub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-299">The configuration should be automated as much as possible, and stored as Infrastructure-as-Code in a Git-based version control system like Azure DevOps or GitHub.</span></span> <span data-ttu-id="aa7a3-300">Essas configurações não podem ser sincronizadas com facilidade em várias implantações.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-300">These settings cannot easily be synchronized across multiple deployments.</span></span> <span data-ttu-id="aa7a3-301">Portanto, recomendamos armazenar e aplicar a configuração externamente e usando o pipeline do DevOps.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-301">Therefore we recommend storing and applying configuration from the outside, and using DevOps pipeline.</span></span>

<span data-ttu-id="aa7a3-302">**Aplicativo**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-302">**Application**</span></span>

<span data-ttu-id="aa7a3-303">O aplicativo deve ser armazenado em um repositório baseado no Git.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-303">The application should be stored in a Git-based repository.</span></span> <span data-ttu-id="aa7a3-304">Sempre que houver uma nova implantação, alterações no aplicativo ou uma recuperação de desastre, elas poderão ser implantadas com facilidade usando o Azure Pipelines.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-304">Whenever there's a new deployment, changes to the application, or disaster recovery, it can be easily deployed using Azure Pipelines.</span></span>

<span data-ttu-id="aa7a3-305">**Dados**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-305">**Data**</span></span>

<span data-ttu-id="aa7a3-306">Os dados são a consideração mais importante na maioria dos designs de aplicativos.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-306">Data is the most important consideration in most application designs.</span></span> <span data-ttu-id="aa7a3-307">Os dados do aplicativo precisam permanecer em sincronia entre as diferentes instâncias do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-307">Application data must stay in sync between the different instances of the application.</span></span> <span data-ttu-id="aa7a3-308">Os dados também precisam ter uma estratégia de backup e recuperação de desastre em caso de interrupção.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-308">Data also needs a backup and disaster recovery strategy if there's an outage.</span></span>

<span data-ttu-id="aa7a3-309">Alcançar esse design depende muito das opções de tecnologia.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-309">Achieving this design depends heavily on technology choices.</span></span> <span data-ttu-id="aa7a3-310">Estes são alguns exemplos de soluções para implementar um banco de dados de modo altamente disponível no Azure Stack Hub:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-310">Here are some solution examples for implementing a database in a highly available fashion on Azure Stack Hub:</span></span>

- [<span data-ttu-id="aa7a3-311">Implantar um grupo de disponibilidade do SQL Server 2016 no Azure e Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-311">Deploy a SQL Server 2016 availability group to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-sql-ha)
- [<span data-ttu-id="aa7a3-312">Implantar uma solução MongoDB de alta disponibilidade no Azure e Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="aa7a3-312">Deploy a highly available MongoDB solution to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-mongodb-ha)

<span data-ttu-id="aa7a3-313">As considerações a serem feitas ao trabalhar com os dados em várias localizações são ainda mais complexas para uma solução altamente disponível e resiliente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-313">Considerations when working with data across multiple locations is an even more complex consideration for a highly available and resilient solution.</span></span> <span data-ttu-id="aa7a3-314">Considere:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-314">Consider:</span></span>

- <span data-ttu-id="aa7a3-315">Latência e conectividade de rede entre Azure Stack Hubs.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-315">Latency and network connectivity between Azure Stack Hubs.</span></span>
- <span data-ttu-id="aa7a3-316">Disponibilidade de identidades para serviços e permissões.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-316">Availability of identities for services and permissions.</span></span> <span data-ttu-id="aa7a3-317">Cada instância do Azure Stack Hub se integra a um diretório externo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-317">Each Azure Stack Hub instance integrates with an external directory.</span></span> <span data-ttu-id="aa7a3-318">Durante a implantação, escolha se deseja usar o Azure AD (Azure Active Directory) ou os ADFS (Serviços de Federação do Active Directory).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-318">During deployment, you choose to use either Azure Active Directory (Azure AD) or Active Directory Federation Services (ADFS).</span></span> <span data-ttu-id="aa7a3-319">Assim, é possível usar uma só identidade que pode interagir com várias instâncias independentes do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-319">As such, there's potential to use a single identity that can interact with multiple independent Azure Stack Hub instances.</span></span>

## <a name="business-continuity-and-disaster-recovery"></a><span data-ttu-id="aa7a3-320">Continuidade dos negócios e recuperação de desastres</span><span class="sxs-lookup"><span data-stu-id="aa7a3-320">Business continuity and disaster recovery</span></span>

<span data-ttu-id="aa7a3-321">A BCDR (continuidade dos negócios e recuperação de desastres) é um tópico importante no Azure Stack Hub e no Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-321">Business continuity and disaster recovery (BCDR) is an important topic in both Azure Stack Hub and Azure.</span></span> <span data-ttu-id="aa7a3-322">A principal diferença é que, no Azure Stack Hub, o operador precisa gerenciar todo o processo de BCDR.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-322">The main difference is that in Azure Stack Hub, the operator must manage the whole BCDR process.</span></span> <span data-ttu-id="aa7a3-323">No Azure, algumas partes da BCDR são gerenciadas automaticamente pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-323">In Azure, parts of BCDR are automatically managed by Microsoft.</span></span>

<span data-ttu-id="aa7a3-324">A BCDR afeta as mesmas áreas mencionadas na seção anterior [Considerações sobre dados e armazenamento](#data-and-storage-considerations):</span><span class="sxs-lookup"><span data-stu-id="aa7a3-324">BCDR affects the same areas mentioned in the previous section [Data and storage considerations](#data-and-storage-considerations):</span></span>

- <span data-ttu-id="aa7a3-325">Infraestrutura/configuração</span><span class="sxs-lookup"><span data-stu-id="aa7a3-325">Infrastructure / Configuration</span></span>
- <span data-ttu-id="aa7a3-326">Disponibilidade do aplicativo</span><span class="sxs-lookup"><span data-stu-id="aa7a3-326">Application Availability</span></span>
- <span data-ttu-id="aa7a3-327">Dados de aplicativos</span><span class="sxs-lookup"><span data-stu-id="aa7a3-327">Application Data</span></span>

<span data-ttu-id="aa7a3-328">Além disso, conforme mencionado na seção anterior, essas áreas são de responsabilidade do operador do Azure Stack Hub e podem variar entre as organizações.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-328">And as mentioned in the previous section, these areas are the responsibility of the Azure Stack Hub operator and can vary between organizations.</span></span> <span data-ttu-id="aa7a3-329">Planeje a BCDR de acordo com as ferramentas e os processos disponíveis.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-329">Plan BCDR according to your available tools and processes.</span></span>

<span data-ttu-id="aa7a3-330">**Infraestrutura e configuração**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-330">**Infrastructure and configuration**</span></span>

<span data-ttu-id="aa7a3-331">Esta seção aborda a infraestrutura física e lógica e a configuração do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-331">This section covers the physical and logical infrastructure and the configuration of Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-332">Ela aborda ações nos espaços do administrador e do locatário.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-332">It covers actions in the admin and the tenant spaces.</span></span>

<span data-ttu-id="aa7a3-333">O operador (ou o administrador) do Azure Stack Hub é responsável pela manutenção das instâncias do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-333">The Azure Stack Hub operator (or administrator) is responsible for maintenance of the Azure Stack Hub instances.</span></span> <span data-ttu-id="aa7a3-334">Incluindo componentes como rede, armazenamento, identidade e outros tópicos que estão fora do escopo deste artigo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-334">Including components such as the network, storage, identity, and other topics that are outside the scope of this article.</span></span> <span data-ttu-id="aa7a3-335">Para saber mais sobre as especificações das operações do Azure Stack Hub, confira os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-335">To learn more about the specifics of Azure Stack Hub operations, see the following resources:</span></span>

- [<span data-ttu-id="aa7a3-336">Recuperar dados no Azure Stack Hub com o serviço Backup de Infraestrutura</span><span class="sxs-lookup"><span data-stu-id="aa7a3-336">Recover data in Azure Stack Hub with the Infrastructure Backup Service</span></span>](/azure-stack/operator/azure-stack-backup-infrastructure-backup)
- [<span data-ttu-id="aa7a3-337">Habilitar o backup para o Azure Stack Hub pelo portal do administrador</span><span class="sxs-lookup"><span data-stu-id="aa7a3-337">Enable backup for Azure Stack Hub from the administrator portal</span></span>](/azure-stack/operator/azure-stack-backup-enable-backup-console)
- [<span data-ttu-id="aa7a3-338">Recuperação da perda de dados catastrófica</span><span class="sxs-lookup"><span data-stu-id="aa7a3-338">Recover from catastrophic data loss</span></span>](/azure-stack/operator/azure-stack-backup-recover-data)
- [<span data-ttu-id="aa7a3-339">Práticas recomendadas do serviço de Backup de Infraestrutura</span><span class="sxs-lookup"><span data-stu-id="aa7a3-339">Infrastructure Backup Service best practices</span></span>](/azure-stack/operator/azure-stack-backup-best-practices)

<span data-ttu-id="aa7a3-340">O Azure Stack Hub é a plataforma e a malha em que os aplicativos do Kubernetes serão implantados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-340">Azure Stack Hub is the platform and fabric on which Kubernetes applications will be deployed.</span></span> <span data-ttu-id="aa7a3-341">O proprietário do aplicativo do Kubernetes será um usuário do Azure Stack Hub, com acesso permitido para implantar a infraestrutura de aplicativo necessária para a solução.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-341">The application owner for the Kubernetes application will be a user of Azure Stack Hub, with access granted to deploy the application infrastructure needed for the solution.</span></span> <span data-ttu-id="aa7a3-342">A infraestrutura do aplicativo, nesse caso, significa o cluster do Kubernetes, implantado por meio do Mecanismo do AKS, e os serviços relacionados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-342">Application infrastructure in this case means the Kubernetes cluster, deployed using AKS Engine, and the surrounding services.</span></span> <span data-ttu-id="aa7a3-343">Esses componentes serão implantados no Azure Stack Hub, restringidos por uma oferta do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-343">These components will be deployed into Azure Stack Hub, constrained by an Azure Stack Hub offer.</span></span> <span data-ttu-id="aa7a3-344">Verifique se a oferta aceita pelo proprietário do aplicativo do Kubernetes tem capacidade suficiente (expressa em cotas do Azure Stack Hub) para implantar a solução inteira.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-344">Make sure the offer accepted by the Kubernetes application owner has sufficient capacity (expressed in Azure Stack Hub quotas) to deploy the entire solution.</span></span> <span data-ttu-id="aa7a3-345">Conforme recomendado na seção anterior, a implantação do aplicativo deve ser automatizada por meio de pipelines de infraestrutura como código e de implantação, como o Azure Pipelines do Azure DevOps.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-345">As recommended in the previous section, the application deployment should be automated using Infrastructure-as-Code and deployment pipelines like Azure DevOps Azure Pipelines.</span></span>

<span data-ttu-id="aa7a3-346">Para obter mais informações sobre as ofertas e as cotas do Azure Stack Hub, confira [Visão geral dos serviços, dos planos, das ofertas e das assinaturas do Azure Stack Hub](/azure-stack/operator/service-plan-offer-subscription-overview)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-346">For more information on Azure Stack Hub offers and quotas, see [Azure Stack Hub services, plans, offers, and subscriptions overview](/azure-stack/operator/service-plan-offer-subscription-overview)</span></span>

<span data-ttu-id="aa7a3-347">É importante salvar e armazenar com segurança a configuração do Mecanismo do AKS, incluindo as respectivas saídas.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-347">It's important to securely save and store the AKS Engine configuration including its outputs.</span></span> <span data-ttu-id="aa7a3-348">Esses arquivos contêm informações confidenciais usadas para acessar o cluster do Kubernetes. Portanto, elas precisam ser protegidas contra exposição a não administradores.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-348">These files contain confidential information used to access the Kubernetes cluster, so it must be protected from being exposed to non-administrators.</span></span>

<span data-ttu-id="aa7a3-349">**Disponibilidade do aplicativo**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-349">**Application availability**</span></span>

<span data-ttu-id="aa7a3-350">O aplicativo não deve depender de backups de uma instância implantada.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-350">The application shouldn't rely on backups of a deployed instance.</span></span> <span data-ttu-id="aa7a3-351">Como uma prática padrão, reimplante o aplicativo por completo seguindo os padrões da infraestrutura como código.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-351">As a standard practice, redeploy the application completely following Infrastructure-as-Code patterns.</span></span> <span data-ttu-id="aa7a3-352">Por exemplo, reimplante-o usando o Azure Pipelines do Azure DevOps.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-352">For example, redeploy using Azure DevOps Azure Pipelines.</span></span> <span data-ttu-id="aa7a3-353">O procedimento da BCDR deve envolver a reimplantação do aplicativo no mesmo ou em outro cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-353">The BCDR procedure should involve the redeployment of the application to the same or another Kubernetes cluster.</span></span>

<span data-ttu-id="aa7a3-354">**Dados do aplicativo**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-354">**Application data**</span></span>

<span data-ttu-id="aa7a3-355">Os dados do aplicativo são a parte crítica necessária para minimizar a perda de dados.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-355">Application data is the critical part to minimize data loss.</span></span> <span data-ttu-id="aa7a3-356">Na seção anterior, foram descritas as técnicas para replicar e sincronizar dados entre duas (ou mais) instâncias do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-356">In the previous section, techniques to replicate and synchronize data between two (or more) instances of the application were described.</span></span> <span data-ttu-id="aa7a3-357">Dependendo da infraestrutura de banco de dados (MySQL, MongoDB, MSSQL ou outras) usada para armazenar os dados, haverá técnicas diferentes de backup e disponibilidade de banco de dados disponíveis para sua escolha.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-357">Depending on the database infrastructure (MySQL, MongoDB, MSSQL or others) used to store the data, there will be different database availability and backup techniques available to choose from.</span></span>

<span data-ttu-id="aa7a3-358">As maneiras recomendadas de alcançar a integridade são:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-358">The recommended ways to achieve integrity are to use either:</span></span>
- <span data-ttu-id="aa7a3-359">Uma solução de backup nativa para o banco de dados específico.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-359">A native backup solution for the specific database.</span></span>
- <span data-ttu-id="aa7a3-360">Uma solução de backup que oficialmente dê suporte ao backup e à recuperação do tipo de banco de dados usado pelo aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-360">A backup solution that officially supports backup and recovery of the database type used by your application.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="aa7a3-361">Não armazene seus dados de backup na mesma instância do Azure Stack Hub em que residem os dados do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-361">Do not store your backup data on the same Azure Stack Hub instance where your application data resides.</span></span> <span data-ttu-id="aa7a3-362">Uma interrupção completa da instância do Azure Stack Hub também comprometerá os backups.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-362">A complete outage of the Azure Stack Hub instance would also compromise your backups.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="aa7a3-363">Considerações sobre disponibilidade</span><span class="sxs-lookup"><span data-stu-id="aa7a3-363">Availability considerations</span></span>

<span data-ttu-id="aa7a3-364">O Kubernetes no Azure Stack Hub implantado por meio do Mecanismo do AKS não é um serviço gerenciado.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-364">Kubernetes on Azure Stack Hub deployed via AKS Engine isn't a managed service.</span></span> <span data-ttu-id="aa7a3-365">É uma implantação e configuração automatizadas de um cluster do Kubernetes usando a IaaS (infraestrutura como serviço) do Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-365">It's an automated deployment and configuration of a Kubernetes cluster using Azure Infrastructure-as-a-Service (IaaS).</span></span> <span data-ttu-id="aa7a3-366">Assim, ele fornece a mesma disponibilidade da infraestrutura subjacente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-366">As such, it provides the same availability as the underlying infrastructure.</span></span>

<span data-ttu-id="aa7a3-367">A infraestrutura do Azure Stack Hub já é resiliente a falhas e oferece funcionalidades como conjuntos de disponibilidade para distribuir componentes entre vários [domínios de falha e atualização](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-367">Azure Stack Hub infrastructure is already resilient to failures, and provides capabilities like Availability Sets to distribute components across multiple [fault and update domains](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span></span> <span data-ttu-id="aa7a3-368">Porém, a tecnologia subjacente (clustering de failover) ainda gera algum tempo de inatividade para as VMs em um servidor físico afetado, em caso de falha de hardware.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-368">But the underlying technology (failover clustering) still incurs some downtime for VMs on an impacted physical server, if there's a hardware failure.</span></span>

<span data-ttu-id="aa7a3-369">É uma boa prática implantar o cluster do Kubernetes de produção, bem como a carga de trabalho, em dois (ou mais) clusters.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-369">It's a good practice to deploy your production Kubernetes cluster as well as the workload to two (or more) clusters.</span></span> <span data-ttu-id="aa7a3-370">Esses clusters devem ser hospedados diferentes localizações ou datacenters e usar tecnologias como o Gerenciador de Tráfego do Azure para encaminhar os usuários com base no tempo de resposta do cluster ou na geografia.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-370">These clusters should be hosted in different locations or datacenters, and use technologies like Azure Traffic Manager to route users based on cluster response time or based on geography.</span></span>

![Como usar o Gerenciador de Tráfego para controlar fluxos de tráfego](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager.png)

<span data-ttu-id="aa7a3-372">Os clientes que têm um só cluster do Kubernetes normalmente se conectam ao nome DNS ou ao IP de serviço de determinado aplicativo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-372">Customers who have a single Kubernetes cluster typically connect to the service IP or DNS name of a given application.</span></span> <span data-ttu-id="aa7a3-373">Em uma implantação de vários clusters, os clientes devem se conectar a um nome DNS do Gerenciador de Tráfego que aponte para os serviços/o ingress em cada cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-373">In a multi-cluster deployment, customers should connect to a Traffic Manager DNS name that points to the services/ingress on each Kubernetes cluster.</span></span>

![Como usar o Gerenciador de Tráfego para encaminhamento para o cluster local](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager-on-premises.png)

> [!NOTE]
> <span data-ttu-id="aa7a3-375">Esse padrão também é uma [melhor prática para clusters (gerenciados) do AKS no Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-375">This pattern is also a [best practice for (managed) AKS clusters in Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span></span>

<span data-ttu-id="aa7a3-376">O próprio cluster do Kubernetes, implantado por meio do Mecanismo do AKS, deve consistir em, pelo menos, três nós mestres e dois nós de trabalho.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-376">The Kubernetes cluster itself, deployed via AKS Engine, should consist of at least three master nodes and two worker nodes.</span></span>

## <a name="identity-and-security-considerations"></a><span data-ttu-id="aa7a3-377">Considerações sobre identidade e segurança</span><span class="sxs-lookup"><span data-stu-id="aa7a3-377">Identity and security considerations</span></span>

<span data-ttu-id="aa7a3-378">Identidade e segurança são tópicos importantes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-378">Identity and security are important topics.</span></span> <span data-ttu-id="aa7a3-379">Especialmente quando a solução abrange instâncias independentes do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-379">Especially when the solution spans independent Azure Stack Hub instances.</span></span> <span data-ttu-id="aa7a3-380">O Kubernetes e o Azure (incluindo o Azure Stack Hub) têm mecanismos distintos para o RBAC (controle de acesso baseado em função):</span><span class="sxs-lookup"><span data-stu-id="aa7a3-380">Kubernetes and Azure (including Azure Stack Hub) both have distinct mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="aa7a3-381">O RBAC do Azure controla o acesso aos recursos no Azure (e no Azure Stack Hub), incluindo a capacidade de criar recursos do Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-381">Azure RBAC controls access to resources in Azure (and Azure Stack Hub), including the ability to create new Azure resources.</span></span> <span data-ttu-id="aa7a3-382">As permissões podem ser atribuídas a usuários, grupos ou entidades de serviço.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-382">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="aa7a3-383">(Uma entidade de serviço é uma identidade de segurança usada pelos aplicativos.)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-383">(A service principal is a security identity used by applications.)</span></span>
- <span data-ttu-id="aa7a3-384">O RBAC do Kubernetes controla permissões para a API do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-384">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="aa7a3-385">Por exemplo, a criação e a listagem de pods são ações que podem ser autorizadas (ou negadas) a um usuário por meio de RBAC.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-385">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="aa7a3-386">Para atribuir permissões de Kubernetes aos usuários, crie funções e associações de função.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-386">To assign Kubernetes permissions to users, you create roles and role bindings.</span></span>

<span data-ttu-id="aa7a3-387">**Identidade e RBAC do Azure Stack Hub**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-387">**Azure Stack Hub identity and RBAC**</span></span>

<span data-ttu-id="aa7a3-388">O Azure Stack Hub fornece duas opções de provedor de identidade.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-388">Azure Stack Hub provides two identity provider choices.</span></span> <span data-ttu-id="aa7a3-389">O provedor usado depende do ambiente e se ele está em execução em um ambiente conectado ou desconectado:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-389">The provider you use depends on the environment and whether running in a connected or disconnected environment:</span></span>

- <span data-ttu-id="aa7a3-390">Azure AD: só pode ser usado em um ambiente conectado.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-390">Azure AD - can only be used in a connected environment.</span></span>
- <span data-ttu-id="aa7a3-391">ADFS para uma floresta tradicional do Active Directory: pode ser usado em um ambiente conectado ou desconectado.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-391">ADFS to a traditional Active Directory forest - can be used in both a connected or disconnected environment.</span></span>

<span data-ttu-id="aa7a3-392">O provedor de identidade gerencia usuários e grupos, incluindo autenticação e autorização para acessar os recursos.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-392">The identity provider manages users and groups, including authentication and authorization for accessing resources.</span></span> <span data-ttu-id="aa7a3-393">O acesso pode ser permitido aos recursos do Azure Stack Hub, como assinaturas, grupos de recursos e recursos individuais, como VMs ou balanceadores de carga.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-393">Access can be granted to Azure Stack Hub resources like subscriptions, resource groups, and individual resources like VMs or load balancers.</span></span> <span data-ttu-id="aa7a3-394">Para ter um modelo de acesso consistente, você deve considerar o uso dos mesmos grupos (diretos ou aninhados) para todos os Azure Stack Hubs.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-394">To have a consistent access model, you should consider using the same groups (either direct or nested) for all Azure Stack Hubs.</span></span> <span data-ttu-id="aa7a3-395">Veja um exemplo de configuração:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-395">Here's a configuration example:</span></span>

![grupos do AAD aninhados com o Azure Stack Hub](media/pattern-highly-available-kubernetes/azure-stack-azure-ad-nested-groups.png)

<span data-ttu-id="aa7a3-397">O exemplo contém um grupo dedicado (usando o AAD ou o ADFS) para uma finalidade específica.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-397">The example contains a dedicated group (using AAD or ADFS) for a specific purpose.</span></span> <span data-ttu-id="aa7a3-398">Por exemplo, para fornecer permissões de Colaborador ao grupo de recursos que contém nossa infraestrutura de cluster do Kubernetes em uma instância específica do Azure Stack Hub (aqui, "Colaborador do Cluster do K8s Seattle").</span><span class="sxs-lookup"><span data-stu-id="aa7a3-398">For example, to provide Contributor permissions for the Resource Group that contains our Kubernetes cluster infrastructure on a specific Azure Stack Hub instance (here "Seattle K8s Cluster Contributor").</span></span> <span data-ttu-id="aa7a3-399">Depois, esses grupos são aninhados em um grupo geral que contém os "subgrupos" de cada Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-399">These groups are then nested into an overall group that contains the "subgroups" for each Azure Stack Hub.</span></span>

<span data-ttu-id="aa7a3-400">Agora, nosso usuário de exemplo terá permissões de "Colaborador" nos grupos de recursos que contêm todo o conjunto de recursos da infraestrutura do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-400">Our sample user will now have "Contributor" permissions to both Resources Groups that contain the entire set of Kubernetes infrastructure resources.</span></span> <span data-ttu-id="aa7a3-401">O usuário terá acesso aos recursos nas duas instâncias do Azure Stack Hub, porque elas compartilham o provedor de identidade.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-401">The user will have access to resources on both Azure Stack Hub instances, because the instances share the same identity provider.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="aa7a3-402">Essas permissões afetam apenas o Azure Stack Hub e alguns dos recursos implantados nele.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-402">These permissions affect only Azure Stack Hub and some of the resources deployed on top of it.</span></span> <span data-ttu-id="aa7a3-403">Um usuário que tenha esse nível de acesso pode causar muitos danos, mas não pode acessar as VMs IaaS do Kubernetes nem a API do Kubernetes sem ter o acesso adicional à implantação do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-403">A user who has this level of access can do a lot of harm, but cannot access the Kubernetes IaaS VMs nor the Kubernetes API without additional access to the Kubernetes deployment.</span></span>

<span data-ttu-id="aa7a3-404">**Identidade e RBAC do Kubernetes**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-404">**Kubernetes identity and RBAC**</span></span>

<span data-ttu-id="aa7a3-405">Por padrão, um cluster do Kubernetes não usa o mesmo provedor de identidade do Azure Stack Hub subjacente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-405">A Kubernetes cluster, by default, doesn't use the same Identity Provider as the underlaying Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-406">As VMs que hospedam o cluster do Kubernetes, o mestre e os nós de trabalho usam a chave SSH especificada durante a implantação do cluster.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-406">The VMs hosting the Kubernetes cluster, the master, and worker nodes, use the SSH Key that is specified during the deployment of the cluster.</span></span> <span data-ttu-id="aa7a3-407">Essa chave SSH é necessária para se conectar a esses nós usando o SSH.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-407">This SSH key is required to connect to these nodes using SSH.</span></span>

<span data-ttu-id="aa7a3-408">A API do Kubernetes (por exemplo, acessada por meio do `kubectl`) também é protegida por contas de serviço, incluindo uma conta de serviço padrão do "administrador do cluster".</span><span class="sxs-lookup"><span data-stu-id="aa7a3-408">The Kubernetes API (for example, accessed by using `kubectl`) is also protected by service accounts including a default "cluster admin" service account.</span></span> <span data-ttu-id="aa7a3-409">As credenciais dessa conta de serviço são inicialmente armazenadas no arquivo `.kube/config` nos nós mestres do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-409">The credentials for this service account are initially stored in the `.kube/config` file on your Kubernetes master nodes.</span></span>

<span data-ttu-id="aa7a3-410">**Credenciais de aplicativo e gerenciamento de segredos**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-410">**Secrets management and application credentials**</span></span>

<span data-ttu-id="aa7a3-411">Para armazenar segredos como cadeias de conexão ou credenciais de banco de dados, há várias opções, incluindo:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-411">To store secrets like connection strings or database credentials there are several choices, including:</span></span>

- <span data-ttu-id="aa7a3-412">Cofre de Chave do Azure</span><span class="sxs-lookup"><span data-stu-id="aa7a3-412">Azure Key Vault</span></span>
- <span data-ttu-id="aa7a3-413">Segredos do Kubernetes</span><span class="sxs-lookup"><span data-stu-id="aa7a3-413">Kubernetes Secrets</span></span>
- <span data-ttu-id="aa7a3-414">Soluções de terceiros como o HashiCorp Vault (em execução no Kubernetes)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-414">3rd-Party solutions like HashiCorp Vault (running on Kubernetes)</span></span>

<span data-ttu-id="aa7a3-415">Não armazene segredos nem credenciais em um texto não criptografado nos arquivos de configuração, no código do aplicativo ou em scripts.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-415">Do not store secrets or credentials in plaintext in your configuration files, application code, or within scripts.</span></span> <span data-ttu-id="aa7a3-416">Não os armazene também em um sistema de controle de versão.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-416">And do not store them in a version control system.</span></span> <span data-ttu-id="aa7a3-417">Em vez disso, a automação da implantação deve recuperar os segredos conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-417">Instead, the deployment automation should retrieve the secrets as needed.</span></span>

## <a name="patch-and-update"></a><span data-ttu-id="aa7a3-418">Patch e atualização</span><span class="sxs-lookup"><span data-stu-id="aa7a3-418">Patch and update</span></span>

<span data-ttu-id="aa7a3-419">O processo de **PNU (Patch e Atualização)** do Serviço de Kubernetes do Azure é parcialmente automatizado.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-419">The **Patch and Update (PNU)** process in Azure Kubernetes Service is partially automated.</span></span> <span data-ttu-id="aa7a3-420">As atualizações de versão do Kubernetes são disparadas manualmente, enquanto as atualizações de segurança são aplicadas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-420">Kubernetes version upgrades are triggered manually, while security updates are applied automatically.</span></span> <span data-ttu-id="aa7a3-421">Essas atualizações podem incluir correções de segurança do sistema operacional ou atualizações de kernel.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-421">These updates can include OS security fixes or kernel updates.</span></span> <span data-ttu-id="aa7a3-422">O AKS não reinicializa automaticamente esses nós do Linux para concluir o processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-422">AKS doesn't automatically reboot these Linux nodes to complete the update process.</span></span> 

<span data-ttu-id="aa7a3-423">O processo de PNU para um cluster do Kubernetes implantado por meio do Mecanismo do AKS no Azure Stack Hub não é gerenciado e é responsabilidade do operador de cluster.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-423">The PNU process for a Kubernetes cluster deployed using AKS Engine on Azure Stack Hub is unmanaged, and is the responsibility of the cluster operator.</span></span> 

<span data-ttu-id="aa7a3-424">O Mecanismo do AKS ajuda com as duas tarefas mais importantes:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-424">AKS Engine helps with the two most important tasks:</span></span>

- [<span data-ttu-id="aa7a3-425">Atualização para uma versão mais recente da imagem base do sistema operacional e do Kubernetes</span><span class="sxs-lookup"><span data-stu-id="aa7a3-425">Upgrade to a newer Kubernetes and base OS image version</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version)
- [<span data-ttu-id="aa7a3-426">Atualização somente da imagem base do sistema operacional</span><span class="sxs-lookup"><span data-stu-id="aa7a3-426">Upgrade the base OS image only</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image)

<span data-ttu-id="aa7a3-427">As imagens base mais recentes do sistema operacional contêm as últimas correções de segurança do sistema operacional e atualizações de kernel.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-427">Newer base OS images contain the latest OS security fixes and kernel updates.</span></span> 

<span data-ttu-id="aa7a3-428">O mecanismo de [atualização autônoma](https://wiki.debian.org/UnattendedUpgrades) instala automaticamente as atualizações de segurança que são lançadas antes de uma nova versão de imagem base do sistema operacional estar disponível no Marketplace do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-428">The [Unattended Upgrade](https://wiki.debian.org/UnattendedUpgrades) mechanism automatically installs security updates that are released before a new base OS image version is available in the Azure Stack Hub Marketplace.</span></span> <span data-ttu-id="aa7a3-429">A atualização autônoma está habilitada por padrão e instala as atualizações de segurança automaticamente, mas não reinicializa os nós de cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-429">Unattended upgrade is enabled by default and installs security updates automatically, but does not reboot the Kubernetes cluster nodes.</span></span> <span data-ttu-id="aa7a3-430">A reinicialização dos nós pode ser automatizada por meio do [**kured (K** Ubernetes **RE** boot **D** aemon)](/azure/aks/node-updates-kured) de software livre.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-430">Rebooting the nodes can be automated using the open-source [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured).</span></span> <span data-ttu-id="aa7a3-431">O kured inspeciona os nós do Linux que exigem uma reinicialização e cuida automaticamente do reagendamento dos pods em execução e do processo de reinicialização dos nós.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-431">Kured watches for Linux nodes that require a reboot, then automatically handle the rescheduling of running pods and node reboot process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="aa7a3-432">Considerações de implantação (CI/CD)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-432">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="aa7a3-433">O Azure e o Azure Stack Hub expõem as mesmas APIs REST do Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-433">Azure and Azure Stack Hub expose the same Azure Resource Manager REST APIs.</span></span> <span data-ttu-id="aa7a3-434">Essas APIs são tratadas como qualquer outra nuvem do Azure (Azure, Azure China 21Vianet e Azure Government).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-434">These APIs are addressed like any other Azure cloud (Azure, Azure China 21Vianet, Azure Government).</span></span> <span data-ttu-id="aa7a3-435">Pode haver diferenças nas versões de API entre as nuvens e o Azure Stack Hub fornece apenas um subconjunto de serviços.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-435">There may be differences in API versions between clouds, and Azure Stack Hub provides only a subset of services.</span></span> <span data-ttu-id="aa7a3-436">O URI do ponto de extremidade de gerenciamento também é diferente para cada nuvem e cada instância do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-436">The management endpoint URI is also different for each cloud, and each instance of Azure Stack Hub.</span></span>

<span data-ttu-id="aa7a3-437">Além das diferenças sutis mencionadas, as APIs REST do Azure Resource Manager oferecem uma forma consistente de interagir com o Azure e o Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-437">Aside from the subtle differences mentioned, Azure Resource Manager REST APIs provide a consistent way to interact with both Azure and Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-438">O mesmo conjunto de ferramentas pode ser usado aqui como é usado com qualquer outra nuvem do Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-438">The same set of tools can be used here as would be used with any other Azure cloud.</span></span> <span data-ttu-id="aa7a3-439">Você pode usar o Azure DevOps, ferramentas como o Jenkins ou o PowerShell para implantar e orquestrar serviços no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-439">You can use Azure DevOps, tools like Jenkins, or PowerShell, to deploy and orchestrate services to Azure Stack Hub.</span></span>

<span data-ttu-id="aa7a3-440">**Considerações**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-440">**Considerations**</span></span>

<span data-ttu-id="aa7a3-441">Uma das principais diferenças quando se trata das implantações do Azure Stack Hub é a questão da acessibilidade da Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-441">One of the major differences when it comes to Azure Stack Hub deployments is the question of Internet accessibility.</span></span> <span data-ttu-id="aa7a3-442">A acessibilidade da Internet determina se um agente de build auto-hospedado ou hospedado pela Microsoft deve ser escolhido para os trabalhos de CI/CD.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-442">Internet accessibility determines whether to select a Microsoft-hosted or a self-hosted build agent for your CI/CD jobs.</span></span>

<span data-ttu-id="aa7a3-443">Um agente auto-hospedado pode ser executado no Azure Stack Hub (como uma VM IaaS) ou em uma sub-rede da rede que possa acessar o Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-443">A self-hosted agent can run on top of Azure Stack Hub (as an IaaS VM) or in a network subnet that can access Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-444">Acesse [Agentes do Azure Pipelines](/azure/devops/pipelines/agents/agents) para saber mais sobre as diferenças.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-444">Go to [Azure Pipelines agents](/azure/devops/pipelines/agents/agents) to learn more about the differences.</span></span>

<span data-ttu-id="aa7a3-445">A seguinte imagem ajuda você a decidir se precisará de um agente de build auto-hospedado ou hospedado pela Microsoft:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-445">The following image helps you to decide if you need a self-hosted or a Microsoft-hosted build agent:</span></span>

![Agentes de build auto-hospedados Sim ou não](media/pattern-highly-available-kubernetes/aks-on-stack-self-hosted-build-agents-yes-or-no.png)

- <span data-ttu-id="aa7a3-447">Os pontos de extremidade de gerenciamento do Azure Stack Hub são acessíveis pela Internet?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-447">Are the Azure Stack Hub management endpoints accessible via Internet?</span></span>
  - <span data-ttu-id="aa7a3-448">Sim: Podemos usar o Azure Pipelines com agentes hospedados pela Microsoft para se conectar ao Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-448">Yes: We can use Azure Pipelines with Microsoft-hosted agents to connect to Azure Stack Hub.</span></span>
  - <span data-ttu-id="aa7a3-449">Não: Precisamos de agentes auto-hospedados que possam se conectar aos pontos de extremidade de gerenciamento do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-449">No: We need self-hosted agents that can connect to Azure Stack Hub's management endpoints.</span></span>
- <span data-ttu-id="aa7a3-450">Nosso cluster do Kubernetes é acessível pela Internet?</span><span class="sxs-lookup"><span data-stu-id="aa7a3-450">Is our Kubernetes cluster accessible via the Internet?</span></span>
  - <span data-ttu-id="aa7a3-451">Sim: Podemos usar o Azure Pipelines com agentes hospedados pela Microsoft para interagir diretamente com o ponto de extremidade de API do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-451">Yes: We can use Azure Pipelines with Microsoft-hosted agents to interact directly with Kubernetes API endpoint.</span></span>
  - <span data-ttu-id="aa7a3-452">Não: Precisamos de agentes auto-hospedados que possam se conectar ao ponto de extremidade da API do cluster do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-452">No: We need self-hosted Agents that can connect to the Kubernetes cluster API endpoint.</span></span>

<span data-ttu-id="aa7a3-453">Nos cenários em que os pontos de extremidade de gerenciamento do Azure Stack Hub e a API do Kubernetes são acessíveis pela Internet, a implantação pode usar um agente hospedado pela Microsoft.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-453">In scenarios where the Azure Stack Hub management endpoints and Kubernetes API are accessible via the internet, the deployment can use a Microsoft-hosted agent.</span></span> <span data-ttu-id="aa7a3-454">Essa implantação resultará em uma arquitetura de aplicativo parecida com esta:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-454">This deployment will result in an application architecture as follows:</span></span>

<span data-ttu-id="aa7a3-455">[![Visão geral da arquitetura pública](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-455">[![Public architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span></span>

<span data-ttu-id="aa7a3-456">Se os pontos de extremidade do Azure Resource Manager, a API do Kubernetes ou ambos não estiverem diretamente acessíveis pela Internet, poderemos aproveitar um agente de build auto-hospedado para executar as etapas do pipeline.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-456">If the Azure Resource Manager endpoints, Kubernetes API, or both aren't directly accessible via the Internet, we can leverage a self-hosted build agent to run the pipeline steps.</span></span> <span data-ttu-id="aa7a3-457">Esse design precisa de menos conectividade e pode ser implantado só com a conectividade de rede local com os pontos de extremidade do Azure Resource Manager e a API do Kubernetes:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-457">This design needs less connectivity, and can be deployed with only on-premises network connectivity to Azure Resource Manager endpoints and the Kubernetes API:</span></span>

<span data-ttu-id="aa7a3-458">[![Visão geral da arquitetura local](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="aa7a3-458">[![On-prem architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span></span>

> [!NOTE]
> <span data-ttu-id="aa7a3-459">**E quanto aos cenários desconectados?**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-459">**What about disconnected scenarios?**</span></span> <span data-ttu-id="aa7a3-460">Nos cenários em que o Azure Stack Hub, o Kubernetes ou ambos não têm pontos de extremidade de gerenciamento para a Internet, ainda é possível usar o Azure DevOps para as implantações.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-460">In scenarios where either Azure Stack Hub or Kubernetes or both of them do not have internet-facing management endpoints, it is still possible to use Azure DevOps for your deployments.</span></span> <span data-ttu-id="aa7a3-461">Use um pool de agentes auto-hospedados (um agente de DevOps em execução no local ou no próprio Azure Stack Hub) ou um Azure DevOps Server totalmente auto-hospedado no local.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-461">You can either use a self-hosted Agent Pool (which is a DevOps Agent running on-premises or on Azure Stack Hub itself) or a completly self-hosted Azure DevOps Server on-premises.</span></span> <span data-ttu-id="aa7a3-462">O agente auto-hospedado precisa apenas de conectividade HTTPS (TCP/443) de saída com a Internet.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-462">The self-hosted agent needs only outbound HTTPS (TCP/443) Internet connectivity.</span></span>

<span data-ttu-id="aa7a3-463">O padrão pode usar um cluster do Kubernetes (implantado e orquestrado com o Mecanismo do AKS) em cada instância do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-463">The pattern can use a Kubernetes cluster (deployed and orchestrated with AKS engine) on each Azure Stack Hub instance.</span></span> <span data-ttu-id="aa7a3-464">Ele inclui um aplicativo que consiste em serviços de front-end, de camada intermediária e de back-end (por exemplo, o MongoDB) e um controlador de entrada baseado no NGINX.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-464">It includes an application consisting of a frontend, a mid-tier, backend services (for example MongoDB), and an nginx-based Ingress Controller.</span></span> <span data-ttu-id="aa7a3-465">Em vez de usar um banco de dados hospedado no cluster do K8s, você pode aproveitar "armazenamentos de dados externos".</span><span class="sxs-lookup"><span data-stu-id="aa7a3-465">Instead of using a database hosted on the K8s cluster, you can leverage "external data stores".</span></span> <span data-ttu-id="aa7a3-466">As opções de banco de dados incluem o MySQL, o SQL Server ou qualquer tipo de banco de dados hospedado fora do Azure Stack Hub ou na IaaS.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-466">Database options include MySQL, SQL Server, or any kind of database hosted outside of Azure Stack Hub or in IaaS.</span></span> <span data-ttu-id="aa7a3-467">Configurações como essa não estão no escopo deste artigo.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-467">Configurations like this aren't in scope here.</span></span>

## <a name="partner-solutions"></a><span data-ttu-id="aa7a3-468">Soluções de parceiros</span><span class="sxs-lookup"><span data-stu-id="aa7a3-468">Partner solutions</span></span>

<span data-ttu-id="aa7a3-469">Há soluções de Parceiros da Microsoft que podem estender as funcionalidades do Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-469">There are Microsoft Partner solutions that can extend the capabilities of Azure Stack Hub.</span></span> <span data-ttu-id="aa7a3-470">Essas soluções foram consideradas úteis nas implantações de aplicativos em execução nos clusters do Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-470">These solutions have been found useful in deployments of applications running on Kubernetes clusters.</span></span>  

## <a name="storage-and-data-solutions"></a><span data-ttu-id="aa7a3-471">Soluções de armazenamento e dados</span><span class="sxs-lookup"><span data-stu-id="aa7a3-471">Storage and data solutions</span></span>

<span data-ttu-id="aa7a3-472">Conforme descrito em [Considerações sobre dados e armazenamento](#data-and-storage-considerations), atualmente, o Azure Stack Hub não tem uma solução nativa para replicar o armazenamento em várias instâncias.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-472">As described in [Data and storage considerations](#data-and-storage-considerations), Azure Stack Hub currently doesn't have a native solution to replicate storage across multiple instances.</span></span> <span data-ttu-id="aa7a3-473">Ao contrário do Azure, a capacidade de replicar o armazenamento em várias regiões não existe.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-473">Unlike Azure, the capability of replicating storage across multiple regions does not exist.</span></span> <span data-ttu-id="aa7a3-474">No Azure Stack Hub, cada instância é a própria nuvem distinta.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-474">In Azure Stack Hub, each instance is its own distinct cloud.</span></span> <span data-ttu-id="aa7a3-475">No entanto, as soluções estão disponíveis por meio de Parceiros da Microsoft que habilitam a replicação de armazenamento entre os Azure Stack Hubs e o Azure.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-475">However, solutions are available from Microsoft Partners that enable storage replication across Azure Stack Hubs and Azure.</span></span> 

<span data-ttu-id="aa7a3-476">**SCALITY**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-476">**SCALITY**</span></span>

<span data-ttu-id="aa7a3-477">O [Scality](https://www.scality.com/) fornece armazenamento em escala da Web que capacita empresas digitais desde 2009.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-477">[Scality](https://www.scality.com/) delivers web-scale storage that has powered digital businesses since 2009.</span></span> <span data-ttu-id="aa7a3-478">O Scality RING, nosso armazenamento definido pelo software, transforma os servidores x86 de mercadoria em um pool de armazenamento ilimitado para qualquer tipo de dados (arquivo e objeto) em escala de petabytes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-478">The Scality RING, our software-defined storage, turns commodity x86 servers into an unlimited storage pool for any type of data –file and object– at petabyte scale.</span></span>

<span data-ttu-id="aa7a3-479">**CLOUDIAN**</span><span class="sxs-lookup"><span data-stu-id="aa7a3-479">**CLOUDIAN**</span></span>

<span data-ttu-id="aa7a3-480">O [Cloudian](https://www.cloudian.com/) simplifica o armazenamento corporativo com armazenamento escalonável ilimitado que consolida conjuntos de dados em massa em um só ambiente facilmente gerenciado.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-480">[Cloudian](https://www.cloudian.com/) simplifies enterprise storage with limitless scalable storage that consolidates massive data sets to a single, easily managed environment.</span></span>

## <a name="next-steps"></a><span data-ttu-id="aa7a3-481">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="aa7a3-481">Next steps</span></span>

<span data-ttu-id="aa7a3-482">Para saber mais sobre os conceitos apresentados neste artigo:</span><span class="sxs-lookup"><span data-stu-id="aa7a3-482">To learn more about concepts introduced in this article:</span></span>

- <span data-ttu-id="aa7a3-483">[Escala entre nuvens](pattern-cross-cloud-scale.md) e [padrões de aplicativo distribuídos geograficamente](pattern-geo-distributed.md) no Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-483">[Cross-cloud scaling](pattern-cross-cloud-scale.md) and [Geo-distributed app patterns](pattern-geo-distributed.md) in Azure Stack Hub.</span></span>
- <span data-ttu-id="aa7a3-484">[Arquitetura de microsserviços no AKS (Serviço de Kubernetes do Azure)](/azure/architecture/reference-architectures/microservices/aks).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-484">[Microservices architecture on Azure Kubernetes Service (AKS)](/azure/architecture/reference-architectures/microservices/aks).</span></span>

<span data-ttu-id="aa7a3-485">Quando estiver pronto para testar o exemplo de solução, prossiga com o [Guia de implantação de cluster de alta disponibilidade do Kubernetes](solution-deployment-guide-highly-available-kubernetes.md).</span><span class="sxs-lookup"><span data-stu-id="aa7a3-485">When you're ready to test the solution example, continue with the [High availability Kubernetes cluster deployment guide](solution-deployment-guide-highly-available-kubernetes.md).</span></span> <span data-ttu-id="aa7a3-486">O guia de implantação fornece instruções passo a passo para a implantação e o teste de seus componentes.</span><span class="sxs-lookup"><span data-stu-id="aa7a3-486">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>